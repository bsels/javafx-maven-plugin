name: Push Build
on:
  push:
    branches: [ main ]
permissions:
  contents: write
  packages: write
jobs:
  build:
    name: Build
    env:
      SEGMENT_DOWNLOAD_TIMEOUT_MINS: '1'
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Setup Java JDK 25
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'
          cache-dependency-path: 'pom.xml'
      - name: Set up Git user
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
      - name: Get current project version
        id: projectVersion
        run: |
          echo "version=$(./mvnw help:evaluate --no-transfer-progress -Dexpression=project.version -q -DforceStdout)" >> $GITHUB_OUTPUT
      - name: Bump version
        id: bumpVersion
        uses: actions/github-script@v8
        env:
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          CURRENT_VERSION: ${{ steps.projectVersion.outputs.version }}
        with:
          script: |
            const commitMessage = process.env.COMMIT_MESSAGE.trim().toLowerCase();
            const [major, minor, patch] = process.env.CURRENT_VERSION.trim().split('.');
            if (commitMessage.startsWith('major')) {
              return `${parseInt(major) + 1}.0.0`;
            }
            if (commitMessage.startsWith('minor')) {
              return `${major}.${parseInt(minor) + 1}.0`;
            }
            if (commitMessage.startsWith('patch')) {
              return `${major}.${minor}.${parseInt(patch) + 1}`;
            }
            return process.env.CURRENT_VERSION;
      - name: Set new project version
        if: ${{ steps.bumpVersion.outputs.result != steps.projectVersion.outputs.version }}
        run: |
          ./mvnw versions:set --no-transfer-progress -DnewVersion=${{ steps.bumpVersion.outputs.result }}
      - name: Build and deploy with Maven
        if: ${{ steps.bumpVersion.outputs.result != steps.projectVersion.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./mvnw --batch-mode --no-transfer-progress clean deploy
      - name: Commit changes
        if: ${{ steps.bumpVersion.outputs.result != steps.projectVersion.outputs.version }}
        run: |
          git commit -am "Released ${{ steps.bumpVersion.outputs.result }} [skip ci]"
          git tag "v${{ steps.bumpVersion.outputs.result }}"
          git push --follow-tags
      - name: Create release
        if: ${{ steps.bumpVersion.outputs.result != steps.projectVersion.outputs.version }}
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: "v${{ steps.bumpVersion.outputs.result }}",
              name: "v${{ steps.bumpVersion.outputs.result }}",
              generate_release_notes: true
            })
